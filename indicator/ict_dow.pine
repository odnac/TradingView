//@version=5
indicator("ICT & Dow [odnac]", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================================
// INPUT SETTINGS
// ============================================================================
leftBars   = input.int(36, "Swing Left Bars")
rightBars  = input.int(6,  "Swing Right Bars (Confirmation)")

showSwings = input.bool(true, "Show Swing High/Low Circles", group="Display Settings")
showBg     = input.bool(true, "Show Trend Background Color", group="Display Settings")

// ============================================================================
// SWING CONFIRMATION LOGIC
// ============================================================================
// Confirms bearish swing high by checking if enough bars are bearish
confirmBearish() =>
    bearCount = 0
    closeDownCount = 0
    for i = 1 to rightBars
        if close[i] < open[i]
            bearCount += 1
        if close[i] < close[i + 1]
            closeDownCount += 1
    (bearCount >= 3) or (closeDownCount >= 3)

// Confirms bullish swing low by checking if enough bars are bullish
confirmBullish() =>
    bullCount = 0
    closeUpCount = 0
    for i = 1 to rightBars
        if close[i] > open[i]
            bullCount += 1
        if close[i] > close[i + 1]
            closeUpCount += 1
    (bullCount >= 3) or (closeUpCount >= 3)

// Detect pivot points
pivotHighPrice = ta.pivothigh(high, leftBars, rightBars)
pivotLowPrice  = ta.pivotlow(low,  leftBars, rightBars)

// Confirm swing points with directional validation
highConfirmed = not na(pivotHighPrice) and confirmBearish()
lowConfirmed  = not na(pivotLowPrice)  and confirmBullish()

// ============================================================================
// VARIABLE MANAGEMENT & TREND DETERMINATION
// ============================================================================
// Store swing high/low prices and bar indices
var float lastHigh = na, var float prevHigh = na
var float lastLow  = na, var float prevLow  = na
var int lastHighBar = na, var int lastLowBar = na

// Trend state: 1 = uptrend, -1 = downtrend, 0 = undefined
var int trend = 0 

// Track if current break is first CHOCH or subsequent BOS
var bool isFirstBreak = true

// Prevent duplicate objects on same bar
var int lastObjectBar = 0

// [KEY] Remember processed swing point prices to prevent duplicates
var float lastConfirmedHighPrice = na
var float lastConfirmedLowPrice = na

// Update swing high data when confirmed
if highConfirmed
    prevHigh := lastHigh
    lastHigh := pivotHighPrice
    lastHighBar := bar_index - rightBars

// Update swing low data when confirmed
if lowConfirmed
    prevLow := lastLow
    lastLow := pivotLowPrice
    lastLowBar := bar_index - rightBars

// Determine trend based on swing structure
int prevTrend = trend
if not na(prevHigh) and not na(prevLow)
    if lastHigh > prevHigh and lastLow > prevLow
        trend := 1  // Higher highs and higher lows = uptrend
    else if lastHigh < prevHigh and lastLow < prevLow
        trend := -1  // Lower highs and lower lows = downtrend

// Reset break tracking when trend changes
if trend != prevTrend
    isFirstBreak := true
    lastConfirmedHighPrice := na
    lastConfirmedLowPrice := na

// ============================================================================
// BOS & CHOCH DETECTION (with duplicate prevention)
// ============================================================================
bool is_break = false
float p = na

// Detect upward break (close crosses above last swing high)
// Only trigger if this price level hasn't been processed before
if trend == 1 and ta.crossover(close, lastHigh) and (na(lastConfirmedHighPrice) or lastHigh != lastConfirmedHighPrice)
    is_break := true
    p := lastHigh
    lastConfirmedHighPrice := lastHigh  // Mark this price as processed

// Detect downward break (close crosses below last swing low)
// Only trigger if this price level hasn't been processed before
else if trend == -1 and ta.crossunder(close, lastLow) and (na(lastConfirmedLowPrice) or lastLow != lastConfirmedLowPrice)
    is_break := true
    p := lastLow
    lastConfirmedLowPrice := lastLow  // Mark this price as processed

// ============================================================================
// RENDERING
// ============================================================================
// Plot swing high/low circles
plot(showSwings and highConfirmed ? pivotHighPrice : na, 
     title="Swing High", 
     color=color.rgb(255, 255, 255, 50), 
     style=plot.style_circles, 
     linewidth=5, 
     offset=-rightBars)

plot(showSwings and lowConfirmed ? pivotLowPrice : na, 
     title="Swing Low", 
     color=color.rgb(255, 255, 255, 50), 
     style=plot.style_circles, 
     linewidth=5, 
     offset=-rightBars)

// Draw break lines and labels when structure break detected
if is_break and bar_index > lastObjectBar
    // Determine start point based on trend direction
    int s = trend == 1 ? lastHighBar : lastLowBar
    
    // Label as CHOCH (Change of Character) for first break, BOS (Break of Structure) for subsequent
    string labelText = isFirstBreak ? "CHoCH" : "BOS"
    color displayColor = trend == 1 ? color.rgb(255, 255, 255) : color.rgb(255, 255, 255)
    
    // Draw horizontal line at break level
    line.new(s, p, bar_index, p, color=color.new(displayColor, 50))
    
    // Add label at midpoint of line
    label.new(
         x = math.round((s + bar_index) / 2), 
         y = p, 
         text = labelText, 
         color = color.new(displayColor, 100), 
         style = trend == 1 ? label.style_label_down : label.style_label_up, 
         textcolor = displayColor,
         size = size.tiny
         )

    lastObjectBar := bar_index
    isFirstBreak := false

// Display trend background color
color trendBg = trend == 1 ? color.new(color.green, 90) : trend == -1 ? color.new(color.red, 90) : na
bgcolor(showBg ? trendBg : na, offset=-rightBars, title="Trend Background")