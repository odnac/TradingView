//@version=6

// Market Structure + fvg & OB 

indicator('ICT [odnac]', overlay = true, max_boxes_count = 500, max_lines_count = 500, max_labels_count = 500)

// ============================================================================
// INPUT PARAMETERS - FVG & OB
// ============================================================================
group_fvgob = 'Fair Value Gaps & Order Blocks'
show_ob   = input.bool(true, 'Show Order Blocks', group = group_fvgob)
show_fvg  = input.bool(true, 'Show Fair Value Gaps', group = group_fvgob)

strong_candle_version = input.string('V1', 'Strong Candle Condition', options = ['V1', 'V2', 'V3'], 
     tooltip = 'V1: 1st body + 3rd body <= 2nd body\nV2: (1st range + 3rd body <= 2nd body) OR (1st body + 3rd range <= 2nd body)\nV3: 1st range + 3rd range <= 2nd range', 
     group = group_fvgob)
max_bars_extend = input.int(100, 'Maximum Bars to Extend', minval = 10, maxval = 500, 
     tooltip = 'Maximum number of bars to extend boxes before stopping', group = group_fvgob)

// ============================================================================
// INPUT PARAMETERS - Market Structure
// ============================================================================
group_ms = 'Market Structure'
versionSelect = input.string('V2', 'Version', options = ['V1', 'V2'], 
     tooltip = 'V1: Use only pivot-detected swings | V2: Auto-update swing points between breaks', group = group_ms)
leftBars      = input.int(36, 'Swing Left Bars',  minval = 1, group = group_ms)
rightBars     = input.int(6,  'Swing Right Bars', minval = 1, group = group_ms)
showSwings    = input.bool(true, 'Show Swing Points', group = group_ms)
showLines     = input.bool(true, 'Show BOS/CHoCH', group = group_ms)
showTrendMode = input.string('Background', 'Trend Visualization', options = ['Background', 'Shape', 'None'], group = group_ms)

// ============================================================================
// FVG & OB - VARIABLES
// ============================================================================
var array<box> ob_boxes       = array.new_box()
var array<int> ob_start_bars  = array.new_int()
var array<box> fvg_boxes      = array.new_box()
var array<int> fvg_start_bars = array.new_int()

is_bullish = close > open
is_bearish = close < open

// ============================================================================
// FVG & OB - FUNCTIONS
// ============================================================================
check_common_condition() =>
    body_1st = math.abs(close[2] - open[2])
    body_2nd = math.abs(close[1] - open[1])
    body_3rd = math.abs(close - open)
    range_1st = high[2] - low[2]
    range_2nd = high[1] - low[1]
    range_3rd = high - low

    strong_middle = false
    if strong_candle_version == 'V1'
        strong_middle := body_1st + body_3rd <= body_2nd
    else if strong_candle_version == 'V2'
        condition1 = range_1st + body_3rd <= body_2nd
        condition2 = body_1st + range_3rd <= body_2nd
        strong_middle := condition1 or condition2
    else
        strong_middle := range_1st + range_3rd <= range_2nd

    tails_dont_touch = false
    if is_bullish[1]
        tails_dont_touch := high[2] < low
    else if is_bearish[1]
        tails_dont_touch := low[2] > high

    [strong_middle and tails_dont_touch, strong_middle, tails_dont_touch]

check_ob_condition() =>
    [common, _, _] = check_common_condition()
    if not common
        [false, 0.0, 0.0, false]
    else
        bullish_ob_1 = is_bullish[2] and is_bullish[1] and is_bearish
        bullish_ob_2 = is_bearish[2] and is_bullish[1] and is_bullish
        bearish_ob_1 = is_bearish[2] and is_bearish[1] and is_bullish
        bearish_ob_2 = is_bullish[2] and is_bearish[1] and is_bearish

        is_bullish_ob = bullish_ob_1 or bullish_ob_2
        is_bearish_ob = bearish_ob_1 or bearish_ob_2
        is_ob = is_bullish_ob or is_bearish_ob

        if is_ob
            [true, high[2], low[2], is_bullish_ob]
        else
            [false, 0.0, 0.0, false]

check_fvg_condition() =>
    [common, _, _] = check_common_condition()
    if not common
        [false, 0.0, 0.0, false]
    else
        all_bullish = is_bullish[2] and is_bullish[1] and is_bullish
        all_bearish = is_bearish[2] and is_bearish[1] and is_bearish

        if all_bullish
            gap_bottom = high[2]
            gap_top    = low
            has_gap    = gap_top > gap_bottom
            [has_gap, gap_top, gap_bottom, true]
        else if all_bearish
            gap_top    = low[2]
            gap_bottom = high
            has_gap    = gap_bottom < gap_top
            [has_gap, gap_top, gap_bottom, false]
        else
            [false, 0.0, 0.0, false]

box_touched(box_top, box_bottom) =>
    not (low > box_top or high < box_bottom)

// ============================================================================
// Market Structure - PIVOT CONFIRMATION
// ============================================================================
confirmBearish() =>
    bearCount = 0
    closeDownCount = 0
    for i = 1 to rightBars
        if close[i] < open[i]
            bearCount += 1
        if close[i] < close[i + 1]
            closeDownCount += 1
    bearCount >= 3 or closeDownCount >= 3

confirmBullish() =>
    bullCount = 0
    closeUpCount = 0
    for i = 1 to rightBars
        if close[i] > open[i]
            bullCount += 1
        if close[i] > close[i + 1]
            closeUpCount += 1
    bullCount >= 3 or closeUpCount >= 3

confirmBearishV2() =>
    bearCount = 0
    for i = 1 to rightBars
        if close[i] < open[i]
            bearCount += 1
    bearCount >= 3

confirmBullishV2() =>
    bullCount = 0
    for i = 1 to rightBars
        if close[i] > open[i]
            bullCount += 1
    bullCount >= 3

ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

// ============================================================================
// Market Structure - VARIABLES & TREND
// ============================================================================
var float lastHighPrice = na
var int   lastHighIndex = na
var float lastLowPrice  = na
var int   lastLowIndex  = na
var int   trend         = 0   // 1 = Bullish, -1 = Bearish, 0 = Neutral

bool isValidHigh = versionSelect == 'V1' ? (not na(ph) and confirmBearish()) : (not na(ph) and confirmBearishV2())
bool isValidLow  = versionSelect == 'V1' ? (not na(pl) and confirmBullish()) : (not na(pl) and confirmBullishV2())

if isValidHigh
    lastHighPrice := ph
    lastHighIndex := bar_index - rightBars

if isValidLow
    lastLowPrice := pl
    lastLowIndex := bar_index - rightBars

colWhite = color.white

// ============================================================================
// Market Structure - BREAK DETECTION
// ============================================================================
if versionSelect == 'V1'
    if not na(lastHighPrice) and ta.crossover(close, lastHighPrice)
        label_text = (trend == -1 or trend == 0) ? 'CHoCH' : 'BOS'
        trend := 1
        if showLines
            line.new(lastHighIndex, lastHighPrice, bar_index, lastHighPrice, color = color.new(colWhite, 50), width = 1)
            midX = int(math.avg(lastHighIndex, bar_index))
            label.new(midX, lastHighPrice, text = label_text, style = label.style_label_down, 
                 color = color.new(colWhite, 100), textcolor = colWhite, size = size.tiny)
        lastHighPrice := na

    else if not na(lastLowPrice) and ta.crossunder(close, lastLowPrice)
        label_text = (trend == 1 or trend == 0) ? 'CHoCH' : 'BOS'
        trend := -1
        if showLines
            line.new(lastLowIndex, lastLowPrice, bar_index, lastLowPrice, color = color.new(colWhite, 50), width = 1)
            midX = int(math.avg(lastLowIndex, bar_index))
            label.new(midX, lastLowPrice, text = label_text, style = label.style_label_up, 
                 color = color.new(colWhite, 100), textcolor = colWhite, size = size.tiny)
        lastLowPrice := na

else // V2
    if not na(lastHighPrice) and ta.crossover(close, lastHighPrice)
        label_text = (trend == -1 or trend == 0) ? 'CHoCH' : 'BOS'
        trend := 1
        
        float minLow = low
        int   minIdx = bar_index
        for i = 0 to (bar_index - lastHighIndex)
            if low[i] < minLow
                minLow := low[i]
                minIdx := bar_index[i]
        lastLowPrice := minLow
        lastLowIndex := minIdx
        
        if showLines
            line.new(lastHighIndex, lastHighPrice, bar_index, lastHighPrice, color = color.new(colWhite, 50), width = 1)
            midX = int(math.avg(lastHighIndex, bar_index))
            label.new(midX, lastHighPrice, text = label_text, style = label.style_label_down, 
                 color = color.new(colWhite, 100), textcolor = colWhite, size = size.tiny)
        lastHighPrice := na

    else if not na(lastLowPrice) and ta.crossunder(close, lastLowPrice)
        label_text = (trend == 1 or trend == 0) ? 'CHoCH' : 'BOS'
        trend := -1
        
        float maxHigh = high
        int   maxIdx  = bar_index
        for i = 0 to (bar_index - lastLowIndex)
            if high[i] > maxHigh
                maxHigh := high[i]
                maxIdx  := bar_index[i]
        lastHighPrice := maxHigh
        lastHighIndex := maxIdx
        
        if showLines
            line.new(lastLowIndex, lastLowPrice, bar_index, lastLowPrice, color = color.new(colWhite, 50), width = 1)
            midX = int(math.avg(lastLowIndex, bar_index))
            label.new(midX, lastLowPrice, text = label_text, style = label.style_label_up, 
                 color = color.new(colWhite, 100), textcolor = colWhite, size = size.tiny)
        lastLowPrice := na

// ============================================================================
// Market Structure - VISUALIZATION
// ============================================================================
plot(showSwings and isValidHigh ? ph : na, 'Swing High', color = color.new(colWhite, 70), style = plot.style_circles, linewidth = 4, offset = -rightBars)
plot(showSwings and isValidLow  ? pl : na, 'Swing Low',  color = color.new(colWhite, 70), style = plot.style_circles, linewidth = 4, offset = -rightBars)

trendColor = trend == 1 ? color.new(color.green, 90) : trend == -1 ? color.new(color.red, 90) : na
bgcolor(showTrendMode == 'Background' ? trendColor : na)
plotshape(showTrendMode == 'Shape' and trend == 1, location = location.bottom, color = trendColor, style = shape.square, size = size.tiny)
plotshape(showTrendMode == 'Shape' and trend == -1, location = location.bottom, color = trendColor, style = shape.square, size = size.tiny)

// ============================================================================
// FVG & OB - UPDATE EXISTING BOXES (CORRECTED LOOPS WITH by 1)
// ============================================================================
if array.size(ob_boxes) > 0
    for i = array.size(ob_boxes) - 1 to 0 by 1
        b         = array.get(ob_boxes, i)
        start_bar = array.get(ob_start_bars, i)
        if not na(b)
            box_top    = box.get_top(b)
            box_bottom = box.get_bottom(b)
            box_right  = box.get_right(b)
            bars_extended = bar_index - start_bar
            if bars_extended >= max_bars_extend or (box_right == bar_index and box_touched(box_top, box_bottom))
                array.remove(ob_boxes, i)
                array.remove(ob_start_bars, i)
            else if box_right == bar_index
                box.set_right(b, bar_index + 1)

if array.size(fvg_boxes) > 0
    for i = array.size(fvg_boxes) - 1 to 0 by 1
        b         = array.get(fvg_boxes, i)
        start_bar = array.get(fvg_start_bars, i)
        if not na(b)
            box_top    = box.get_top(b)
            box_bottom = box.get_bottom(b)
            box_right  = box.get_right(b)
            bars_extended = bar_index - start_bar
            if bars_extended >= max_bars_extend or (box_right == bar_index and box_touched(box_top, box_bottom))
                array.remove(fvg_boxes, i)
                array.remove(fvg_start_bars, i)
            else if box_right == bar_index
                box.set_right(b, bar_index + 1)

// ============================================================================
// FVG & OB - DETECT AND CREATE NEW BOXES
// ============================================================================
[is_ob, ob_high, ob_low, _] = check_ob_condition()
if is_ob and show_ob
    b = box.new(bar_index[2], ob_high, bar_index + 1, ob_low, 
         border_color = color.new(color.white, 100), bgcolor = color.new(color.white, 90), border_width = 0)
    array.push(ob_boxes, b)
    array.push(ob_start_bars, bar_index)

[is_fvg, fvg_top, fvg_bottom, _] = check_fvg_condition()
if is_fvg and show_fvg
    b = box.new(bar_index[2], fvg_top, bar_index + 1, fvg_bottom, 
         border_color = color.new(color.yellow, 100), bgcolor = color.new(color.yellow, 90), border_width = 0)
    array.push(fvg_boxes, b)
    array.push(fvg_start_bars, bar_index)