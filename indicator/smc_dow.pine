//@version=6
indicator('SMC & Dow [odnac]', overlay = true, max_lines_count = 500)

// ============================================================================
// INPUT SETTINGS
// ============================================================================
grp_swing  = "Swing Detection Settings"
leftBars   = input.int(36, 'Swing Left Bars', minval = 1, group = grp_swing)
rightBars  = input.int(6,  'Swing Right Bars', minval = 1, group = grp_swing)

grp_vis    = "Visibility Settings"
showSwings = input.bool(true, 'Show Swing Points (Circles)', group = grp_vis)
showLines  = input.bool(true, 'Show Breakout Lines', group = grp_vis)
showDow    = input.bool(true, 'Show Dow Trend (Top Shape)', group = grp_vis)
showBreak  = input.bool(true, 'Show Breakout Trend (Bottom Shape)', group = grp_vis)
showBg     = input.bool(true, 'Show Combined Trend Background', group = grp_vis)
flagOffset = input.bool(false, 'offset', tooltip = 'offset')

// ============================================================================
// PIVOT & CONFIRMATION LOGIC
// ============================================================================
confirmBearish() =>
    bearCount = 0
    closeDownCount = 0
    for i = 1 to rightBars by 1
        if close[i] < open[i]
            bearCount := bearCount + 1
        if close[i] < close[i + 1]
            closeDownCount := closeDownCount + 1
    bearCount >= 3 or closeDownCount >= 3

confirmBullish() =>
    bullCount = 0
    closeUpCount = 0
    for i = 1 to rightBars by 1
        if close[i] > open[i]
            bullCount := bullCount + 1
        if close[i] > close[i + 1]
            closeUpCount := closeUpCount + 1
    bullCount >= 3 or closeUpCount >= 3

ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

// ============================================================================
// STATE MANAGEMENT
// ============================================================================
var float lastHighPrice = na
var int   lastHighIndex = na
var float lastLowPrice  = na
var int   lastLowIndex  = na

var float prevHighPrice = na
var float prevLowPrice  = na

var int trendDow   = 0 // 1: Bull, -1: Bear (Dow Theory)
var int trendBreak = 0 // 1: Bull, -1: Bear (Simple Breakout)

// Update Swing Points
if not na(ph) and confirmBearish()
    prevHighPrice := lastHighPrice
    lastHighPrice := ph
    lastHighIndex := bar_index - rightBars

if not na(pl) and confirmBullish()
    prevLowPrice := lastLowPrice
    lastLowPrice := pl
    lastLowIndex := bar_index - rightBars

// ============================================================================
// 1. DOW THEORY LOGIC (HH+HL / LH+LL)
// ============================================================================
isHH = lastHighPrice > prevHighPrice
isHL = lastLowPrice > prevLowPrice
isLH = lastHighPrice < prevHighPrice
isLL = lastLowPrice < prevLowPrice

if isHH and isHL
    trendDow := 1
else if isLH and isLL
    trendDow := -1

// ============================================================================
// 2. SIMPLE BREAKOUT LOGIC & LINE DRAWING
// ============================================================================
colWhite = color.rgb(255, 255, 255)

// Bullish Breakout
if not na(lastHighPrice) and ta.crossover(close, lastHighPrice)
    trendBreak := 1
    if showLines
        line.new(lastHighIndex, lastHighPrice, bar_index, lastHighPrice, color = color.new(colWhite, 50), width = 1)
    lastHighPrice := na

// Bearish Breakout
else if not na(lastLowPrice) and ta.crossunder(close, lastLowPrice)
    trendBreak := -1
    if showLines
        line.new(lastLowIndex, lastLowPrice, bar_index, lastLowPrice, color = color.new(colWhite, 50), width = 1)
    lastLowPrice := na

// ============================================================================
// VISUALIZATION
// ============================================================================
// 1. Combined Background (Agreeing Trends)
combinedTrendColor = (trendDow == 1 and trendBreak == 1) ? color.new(color.green, 90) : 
                     (trendDow == -1 and trendBreak == -1) ? color.new(color.red, 90) : na
bgcolor(showBg ? combinedTrendColor : na, title = "Trend Background", offset = flagOffset ? -rightBars : na)

// 2. Dow Theory Shape (Top)
plotshape(showDow and trendDow == 1,  "Dow Bullish", location=location.top, color=color.new(color.green, 90), style=shape.square, size=size.tiny, offset = flagOffset ? -rightBars : na)
plotshape(showDow and trendDow == -1, "Dow Bearish", location=location.top, color=color.new(color.red, 90),   style=shape.square, size=size.tiny, offset = flagOffset ? -rightBars : na)

// 3. Simple Breakout Shape (Bottom)
plotshape(showBreak and trendBreak == 1,  "Break Bullish", location=location.bottom, color=color.new(color.green, 90), style=shape.square, size=size.tiny)
plotshape(showBreak and trendBreak == -1, "Break Bearish", location=location.bottom, color=color.new(color.red, 90),   style=shape.square, size=size.tiny)

// 4. Swing Points (Circles)
plot(showSwings and not na(ph) and confirmBearish() ? ph : na, 'SH', color = color.new(colWhite, 70), style = plot.style_circles, linewidth = 4, offset = -rightBars)
plot(showSwings and not na(pl) and confirmBullish() ? pl : na, 'SL', color = color.new(colWhite, 70), style = plot.style_circles, linewidth = 4, offset = -rightBars)